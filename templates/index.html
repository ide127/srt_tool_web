<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT ì²˜ë¦¬ ë„êµ¬ v5.3 (Workflow Refined)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .log-box {
            background-color: #212529; color: #f8f9fa;
            font-family: 'Courier New', Courier, monospace; font-size: 0.85rem;
            height: 450px; overflow-y: scroll; border-radius: 5px;
            padding: 15px; white-space: pre-wrap; word-wrap: break-word;
        }
        .log-entry { display: block; border-bottom: 1px solid #495057; padding-bottom: 5px; margin-bottom: 5px; }
        .log-entry.INFO { color: #f8f9fa; }
        .log-entry.WARNING { color: #ffc107; }
        .log-entry.ERROR { color: #dc3545; font-weight: bold; }
        .log-entry.CONTEXT { color: #0dcaf0; font-family: monospace; white-space: pre; }
        .nav-tabs .nav-link.active { border-bottom: 2px solid #0d6efd; }
        .list-group-item.active { z-index: 2; color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <header class="text-center mb-4">
            <h1>ğŸ¬ SRT ì²˜ë¦¬ ë„êµ¬ v5.3 (Workflow Refined)</h1>
            <p class="lead">SRT ìë§‰ íŒŒì¼ì˜ ë¼ë²¨ë§, ë²ˆì—­ ë° ê¸°íƒ€ ë„êµ¬</p>
        </header>

        {% if not api_key_exists %}
        <div class="alert alert-danger" role="alert">
            <strong>ê²½ê³ :</strong> <code>.env</code> íŒŒì¼ì— <strong>GOOGLE_API_KEY</strong>ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="toolTabs" role="tablist">
                    <li class="nav-item" role="presentation"> <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#main-workflow" type="button">ì›í´ë¦­ ë²ˆì—­</button> </li>
                    <li class="nav-item" role="presentation"> <button class="nav-link" data-bs-toggle="tab" data-bs-target="#shifter" type="button">ì‹œê°„ ì¼ê´„ ì¡°ì ˆ</button> </li>
                    <li class="nav-item" role="presentation"> <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vad" type="button" onclick="loadVideoFiles()">VAD ìë§‰ ìƒì„±</button> </li>
                    <li class="nav-item" role="presentation"> <button class="nav-link" data-bs-toggle="tab" data-bs-target="#capcut" type="button" onclick="loadCapcutProjects()">CapCut ìë§‰ ì¶”ì¶œ</button> </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="toolTabsContent">
                    <div class="tab-pane fade show active" id="main-workflow" role="tabpanel">
                        <h5>1. ì²˜ë¦¬í•  ì—í”¼ì†Œë“œ ë° ì˜µì…˜</h5>
                        <p>ì‘ì—…í•  ì—í”¼ì†Œë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: <code>181-188,56</code>)</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="episodes" placeholder="181-188,56">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" value="" id="skip-review-checkbox">
                            <label class="form-check-label" for="skip-review-checkbox">
                                1ë‹¨ê³„(ë¼ë²¨ë§) í›„ ê²€í†  ì—†ì´ ì¦‰ì‹œ 2ë‹¨ê³„(ë²ˆì—­) ì§„í–‰
                            </label>
                        </div>
                        <h5>2. ì‘ì—… ì‹¤í–‰</h5>
                        <div class="d-grid gap-2 d-md-flex">
                             <button class="btn btn-primary" onclick="startLabeling()" id="btnStep1">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                1ë‹¨ê³„: ë¶„ë¦¬ ë° ë¼ë²¨ë§
                             </button>
                             <button class="btn btn-success" onclick="startTranslation()" id="btnStep2">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                2ë‹¨ê³„: ë²ˆì—­ ë° ë³‘í•©
                             </button>
                        </div>
                        <div class="alert alert-info mt-3" role="alert">
                            <strong>ì‘ì—… ìˆœì„œ:</strong><br>
                            1. ì—í”¼ì†Œë“œ ì…ë ¥ í›„ <strong>[1ë‹¨ê³„]</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
                            2. 'ì¦‰ì‹œ ì§„í–‰' ì²´í¬ ì‹œ: 1, 2ë‹¨ê³„ê°€ ì—°ì†ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.<br>
                            3. 'ì¦‰ì‹œ ì§„í–‰' ì²´í¬ í•´ì œ ì‹œ: 1ë‹¨ê³„ ì™„ë£Œ í›„, `txtWithLabeling` í´ë” ë‚´ìš©ì„ ìˆ˜ì •í•œ ë’¤ <strong>[2ë‹¨ê³„]</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
                        </div>
                    </div>
                    <div class="tab-pane fade" id="shifter" role="tabpanel"></div>
                    <div class="tab-pane fade" id="vad" role="tabpanel"></div>
                    <div class="tab-pane fade" id="capcut" role="tabpanel">
                        <h5>CapCut í”„ë¡œì íŠ¸ì—ì„œ ìë§‰ ì¶”ì¶œ</h5>
                        <div class="mb-3">
                            <label for="capcut-path" class="form-label">CapCut í”„ë¡œì íŠ¸ ê²½ë¡œ</label>
                            <input type="text" class="form-control" id="capcut-path" value="C:\Users\a7182\AppData\Local\CapCut\User Data\Projects\com.lveditor.draft">
                            <small class="form-text text-muted">
                                (WSL2 í™˜ê²½ ì‚¬ìš© ì‹œ) ìœˆë„ìš° ê²½ë¡œë¥¼ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ì‹œë©´ í”„ë¡œê·¸ë¨ì´ ìë™ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary mb-2" onclick="loadCapcutProjects()">ê²½ë¡œ ìƒˆë¡œê³ ì¹¨</button>
                        <div id="capcut-list-container" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-primary" onclick="runCapcutExtraction()" id="btnCapcut">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                            ì„ íƒ í”„ë¡œì íŠ¸ ìë§‰ ì¶”ì¶œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ì‹¤ì‹œê°„ ì²˜ë¦¬ ë¡œê·¸</span>
                <div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-info" value="INFO" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-info">INFO</label> </div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-warning" value="WARNING" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-warning">WARN</label> </div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-error" value="ERROR" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-error">ERROR</label> </div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-context" value="CONTEXT" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-context">CONTEXT</label> </div>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
                </div>
            </div>
            <div class="card-body">
                <div id="log-box" class="log-box"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ... ëŒ€ë¶€ë¶„ì˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ê³¼ ë™ì¼ ...
        // [í•µì‹¬ ìˆ˜ì •] ì‘ì—… ì‹œì‘ í•¨ìˆ˜ë“¤
        function startLabeling() {
            const episodes = document.getElementById('episodes').value;
            const skipReview = document.getElementById('skip-review-checkbox').checked;
            if (!episodes) { alert('ì—í”¼ì†Œë“œ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            postRequest('/start-labeling', { episodes, skip_review: skipReview }, 'btnStep1');
        }

        function startTranslation() {
            const episodes = document.getElementById('episodes').value;
            if (!episodes) { alert('ì—í”¼ì†Œë“œ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            postRequest('/start-translation', { episodes }, 'btnStep2');
        }

        // --- ì´í•˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ê³¼ ê±°ì˜ ë™ì¼ ---
        const logBox = document.getElementById('log-box');
        function clearLogs() { logBox.innerHTML = ''; }
        function addLog(message, level='INFO') {
            const logEntry = document.createElement('span');
            logEntry.classList.add('log-entry', level);
            logEntry.textContent = message;
            logBox.appendChild(logEntry);
            logBox.appendChild(document.createElement('br'));
            logBox.scrollTop = logBox.scrollHeight;
            updateLogFilter();
        }

        function updateLogFilter() {
            const filters = {
                INFO: document.getElementById('log-filter-info').checked,
                WARNING: document.getElementById('log-filter-warning').checked,
                ERROR: document.getElementById('log-filter-error').checked,
                CONTEXT: document.getElementById('log-filter-context').checked
            };
            const entries = logBox.getElementsByClassName('log-entry');
            for (let entry of entries) {
                let isVisible = false;
                for (let level in filters) {
                    if (entry.classList.contains(level) && filters[level]) {
                        isVisible = true;
                        break;
                    }
                }
                entry.style.display = isVisible ? 'inline' : 'none';
                if (entry.nextSibling && entry.nextSibling.tagName === 'BR') {
                    entry.nextSibling.style.display = isVisible ? 'block' : 'none';
                }
            }
        }

        const eventSource = new EventSource("/stream-logs");
        eventSource.onmessage = function(event) {
            if (event.data) {
                const dataMatch = event.data.match(/^\[(.*?)\]\s*(.*)$/s);
                if (dataMatch) { addLog(dataMatch[2], dataMatch[1]); }
                else { addLog(event.data); }
            }
        };
        eventSource.onerror = function(err) {
            addLog('[SYSTEM] ë¡œê·¸ ì„œë²„ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.', 'ERROR');
            eventSource.close();
        };

        async function postRequest(url, body, buttonId) {
            const button = document.getElementById(buttonId);
            const spinner = button ? button.querySelector('.spinner-border') : null;
            if (button) {
                button.disabled = true;
                if(spinner) spinner.style.display = 'inline-block';
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (!response.ok) { addLog(`[SYSTEM] ì˜¤ë¥˜: ${result.message}`, 'ERROR'); }
            } catch (error) {
                addLog(`[SYSTEM] ìš”ì²­ ì‹¤íŒ¨: ${error}`, 'ERROR');
            } finally {
                if (button) {
                    button.disabled = false;
                    if(spinner) spinner.style.display = 'none';
                }
            }
        }
        
        function runTimeShift() { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        function runVad() { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        function runCapcutExtraction() { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        async function loadDynamicList(url, containerId, placeholderText, notFoundText) { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        function loadVideoFiles() { /* ... ì´ì „ê³¼ ë™ì¼ ... */ }
        function loadCapcutProjects() {
            const path = document.getElementById('capcut-path').value;
            const url = `/get-capcut-projects?path=${encodeURIComponent(path)}`;
            loadDynamicList(url, 'capcut-list-container', 'CapCut í”„ë¡œì íŠ¸ ë¡œë”© ì¤‘...', 'í•´ë‹¹ ê²½ë¡œì—ì„œ CapCut í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html>