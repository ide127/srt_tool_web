<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT 처리 도구 v5.3 (Workflow Refined)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .log-box {
            background-color: #212529; color: #f8f9fa;
            font-family: 'Courier New', Courier, monospace; font-size: 0.85rem;
            height: 450px; overflow-y: scroll; border-radius: 5px;
            padding: 15px; white-space: pre-wrap; word-wrap: break-word;
        }
        .log-entry { display: block; border-bottom: 1px solid #495057; padding-bottom: 5px; margin-bottom: 5px; }
        .log-entry.INFO { color: #f8f9fa; }
        .log-entry.WARNING { color: #ffc107; }
        .log-entry.ERROR { color: #dc3545; font-weight: bold; }
        .log-entry.CONTEXT { color: #0dcaf0; font-family: monospace; white-space: pre; }
        .nav-tabs .nav-link.active { border-bottom: 2px solid #0d6efd; }
        .list-group-item.active { z-index: 2; color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <header class="text-center mb-4">
            <h1>🎬 SRT 처리 도구 v5.3 (Workflow Refined)</h1>
            <p class="lead">SRT 자막 파일의 라벨링, 번역 및 기타 도구</p>
        </header>

        {% if not api_key_exists %}
        <div class="alert alert-danger" role="alert">
            <strong>경고:</strong> <code>.env</code> 파일에 <strong>GOOGLE_API_KEY</strong>가 설정되지 않았습니다. 프로그램이 정상적으로 작동하지 않습니다.
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="toolTabs" role="tablist">
                    <li class="nav-item" role="presentation"> <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#main-workflow" type="button">원클릭 번역</button> </li>
                    <li class="nav-item" role="presentation"> <button class="nav-link" data-bs-toggle="tab" data-bs-target="#shifter" type="button">시간 일괄 조절</button> </li>
                    <li class="nav-item" role="presentation"> <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vad" type="button" onclick="loadVideoFiles()">VAD 자막 생성</button> </li>
                    <li class="nav-item" role="presentation"> <button class="nav-link" data-bs-toggle="tab" data-bs-target="#capcut" type="button" onclick="loadCapcutProjects()">CapCut 자막 추출</button> </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="toolTabsContent">
                    <div class="tab-pane fade show active" id="main-workflow" role="tabpanel">
                        <h5>1. 처리할 에피소드 및 옵션</h5>
                        <p>작업할 에피소드 번호를 입력하세요. (예: <code>181-188,56</code>)</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="episodes" placeholder="181-188,56">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" value="" id="skip-review-checkbox">
                            <label class="form-check-label" for="skip-review-checkbox">
                                1단계(라벨링) 후 검토 없이 즉시 2단계(번역) 진행
                            </label>
                        </div>
                        <h5>2. 작업 실행</h5>
                        <div class="d-grid gap-2 d-md-flex">
                             <button class="btn btn-primary" onclick="startLabeling()" id="btnStep1">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                1단계: 분리 및 라벨링
                             </button>
                             <button class="btn btn-success" onclick="startTranslation()" id="btnStep2">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                2단계: 번역 및 병합
                             </button>
                        </div>
                        <div class="alert alert-info mt-3" role="alert">
                            <strong>작업 순서:</strong><br>
                            1. 에피소드 입력 후 <strong>[1단계]</strong> 버튼을 누르세요.<br>
                            2. '즉시 진행' 체크 시: 1, 2단계가 연속으로 실행됩니다.<br>
                            3. '즉시 진행' 체크 해제 시: 1단계 완료 후, `txtWithLabeling` 폴더 내용을 수정한 뒤 <strong>[2단계]</strong> 버튼을 누르세요.
                        </div>
                    </div>
                    <div class="tab-pane fade" id="shifter" role="tabpanel"></div>
                    <div class="tab-pane fade" id="vad" role="tabpanel"></div>
                    <div class="tab-pane fade" id="capcut" role="tabpanel">
                        <h5>CapCut 프로젝트에서 자막 추출</h5>
                        <div class="mb-3">
                            <label for="capcut-path" class="form-label">CapCut 프로젝트 경로</label>
                            <input type="text" class="form-control" id="capcut-path" value="C:\Users\a7182\AppData\Local\CapCut\User Data\Projects\com.lveditor.draft">
                            <small class="form-text text-muted">
                                (WSL2 환경 사용 시) 윈도우 경로를 그대로 입력하시면 프로그램이 자동으로 변환합니다.
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary mb-2" onclick="loadCapcutProjects()">경로 새로고침</button>
                        <div id="capcut-list-container" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-primary" onclick="runCapcutExtraction()" id="btnCapcut">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                            선택 프로젝트 자막 추출
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>실시간 처리 로그</span>
                <div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-info" value="INFO" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-info">INFO</label> </div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-warning" value="WARNING" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-warning">WARN</label> </div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-error" value="ERROR" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-error">ERROR</label> </div>
                    <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" id="log-filter-context" value="CONTEXT" checked onchange="updateLogFilter()"> <label class="form-check-label" for="log-filter-context">CONTEXT</label> </div>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearLogs()">로그 지우기</button>
                </div>
            </div>
            <div class="card-body">
                <div id="log-box" class="log-box"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ... 대부분의 스크립트는 이전과 동일 ...
        // [핵심 수정] 작업 시작 함수들
        function startLabeling() {
            const episodes = document.getElementById('episodes').value;
            const skipReview = document.getElementById('skip-review-checkbox').checked;
            if (!episodes) { alert('에피소드 범위를 입력해주세요.'); return; }
            postRequest('/start-labeling', { episodes, skip_review: skipReview }, 'btnStep1');
        }

        function startTranslation() {
            const episodes = document.getElementById('episodes').value;
            if (!episodes) { alert('에피소드 범위를 입력해주세요.'); return; }
            postRequest('/start-translation', { episodes }, 'btnStep2');
        }

        // --- 이하 스크립트는 이전과 거의 동일 ---
        const logBox = document.getElementById('log-box');
        function clearLogs() { logBox.innerHTML = ''; }
        function addLog(message, level='INFO') {
            const logEntry = document.createElement('span');
            logEntry.classList.add('log-entry', level);
            logEntry.textContent = message;
            logBox.appendChild(logEntry);
            logBox.appendChild(document.createElement('br'));
            logBox.scrollTop = logBox.scrollHeight;
            updateLogFilter();
        }

        function updateLogFilter() {
            const filters = {
                INFO: document.getElementById('log-filter-info').checked,
                WARNING: document.getElementById('log-filter-warning').checked,
                ERROR: document.getElementById('log-filter-error').checked,
                CONTEXT: document.getElementById('log-filter-context').checked
            };
            const entries = logBox.getElementsByClassName('log-entry');
            for (let entry of entries) {
                let isVisible = false;
                for (let level in filters) {
                    if (entry.classList.contains(level) && filters[level]) {
                        isVisible = true;
                        break;
                    }
                }
                entry.style.display = isVisible ? 'inline' : 'none';
                if (entry.nextSibling && entry.nextSibling.tagName === 'BR') {
                    entry.nextSibling.style.display = isVisible ? 'block' : 'none';
                }
            }
        }

        const eventSource = new EventSource("/stream-logs");
        eventSource.onmessage = function(event) {
            if (event.data) {
                const dataMatch = event.data.match(/^\[(.*?)\]\s*(.*)$/s);
                if (dataMatch) { addLog(dataMatch[2], dataMatch[1]); }
                else { addLog(event.data); }
            }
        };
        eventSource.onerror = function(err) {
            addLog('[SYSTEM] 로그 서버 연결이 끊겼습니다. 페이지를 새로고침 하세요.', 'ERROR');
            eventSource.close();
        };

        async function postRequest(url, body, buttonId) {
            const button = document.getElementById(buttonId);
            const spinner = button ? button.querySelector('.spinner-border') : null;
            if (button) {
                button.disabled = true;
                if(spinner) spinner.style.display = 'inline-block';
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (!response.ok) { addLog(`[SYSTEM] 오류: ${result.message}`, 'ERROR'); }
            } catch (error) {
                addLog(`[SYSTEM] 요청 실패: ${error}`, 'ERROR');
            } finally {
                if (button) {
                    button.disabled = false;
                    if(spinner) spinner.style.display = 'none';
                }
            }
        }
        
        function runTimeShift() { /* ... 이전과 동일 ... */ }
        function runVad() { /* ... 이전과 동일 ... */ }
        function runCapcutExtraction() { /* ... 이전과 동일 ... */ }
        async function loadDynamicList(url, containerId, placeholderText, notFoundText) { /* ... 이전과 동일 ... */ }
        function loadVideoFiles() { /* ... 이전과 동일 ... */ }
        function loadCapcutProjects() {
            const path = document.getElementById('capcut-path').value;
            const url = `/get-capcut-projects?path=${encodeURIComponent(path)}`;
            loadDynamicList(url, 'capcut-list-container', 'CapCut 프로젝트 로딩 중...', '해당 경로에서 CapCut 프로젝트를 찾을 수 없습니다.');
        }
    </script>
</body>
</html>